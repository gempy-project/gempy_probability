
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "examples_basic_geology/1-thickness_problem.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_examples_basic_geology_1-thickness_problem.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_examples_basic_geology_1-thickness_problem.py:


2.1 - Only Pyro
===============


Model definition
----------------

Same problem as before, letâ€™s assume the observations are layer
thickness measurements taken on an outcrop. Now, in the previous example
we chose a prior for the mean arbitrarily:
:math:`ðœ‡âˆ¼Normal(mu=10.0, sigma=5.0)`â€“something that made sense for these
specific data set. If we do not have any further information, keeping
an uninformative prior and let the data to dictate the final value of
the inference is the sensible way forward. However, this also enable to
add information to the system by setting informative priors.

Imagine we get a borehole with the tops of the two interfaces of
interest. Each of this data point will be a random variable itself since
the accuracy of the exact 3D location will be always limited. Notice
that this two data points refer to depth not to thicknessâ€“the unit of
the rest of the observations. Therefore, the first step would be to
perform a transformation of the parameters into the observations space.
Naturally in this example a simple subtraction will suffice.

Now we can define the probabilistic models:

.. GENERATED FROM PYTHON SOURCE LINES 29-31

.. code-block:: python3

    # sphinx_gallery_thumbnail_number = -2








.. GENERATED FROM PYTHON SOURCE LINES 32-34

Importing Necessary Libraries
-----------------------------

.. GENERATED FROM PYTHON SOURCE LINES 34-45

.. code-block:: python3


    import os
    import matplotlib.pyplot as plt
    import pyro
    import pyro.distributions as dist
    import torch
    from pyro.infer import MCMC, NUTS, Predictive
    from pyro.infer.inspect import get_dependencies
    from gempy_probability.plot_posterior import PlotPosterior, default_red, default_blue
    import arviz as az








.. GENERATED FROM PYTHON SOURCE LINES 46-51

Introduction to the Problem
---------------------------
In this example, we are considering layer thickness measurements taken on an outcrop as our observations.
We use a probabilistic approach to model these observations, allowing for the inclusion of prior knowledge
and uncertainty quantification.

.. GENERATED FROM PYTHON SOURCE LINES 51-59

.. code-block:: python3


    # Setting the working directory for sphinx gallery
    cwd = os.getcwd()
    if 'examples' not in cwd:
        path_dir = os.getcwd() + '/examples/tutorials/ch5_probabilistic_modeling'
    else:
        path_dir = cwd








.. GENERATED FROM PYTHON SOURCE LINES 60-65

Defining the Observations and Model
-----------------------------------
The observations are layer thickness measurements. We define a Pyro probabilistic model
that uses Normal and Gamma distributions to model the top and bottom interfaces of the layers
and their respective uncertainties.

.. GENERATED FROM PYTHON SOURCE LINES 65-88

.. code-block:: python3


    # Defining observed data
    y_obs = torch.tensor([2.12])
    y_obs_list = torch.tensor([2.12, 2.06, 2.08, 2.05, 2.08, 2.09, 2.19, 2.07, 2.16, 2.11, 2.13, 1.92])
    pyro.set_rng_seed(4003)

    # Defining the probabilistic model
    def model(y_obs_list_):
        mu_top = pyro.sample(r'$\mu_{top}$', dist.Normal(3.05, 0.2))
        sigma_top = pyro.sample(r"$\sigma_{top}$", dist.Gamma(0.3, 3.0))
        y_top = pyro.sample(r"y_{top}", dist.Normal(mu_top, sigma_top), obs=torch.tensor([3.02]))

        mu_bottom = pyro.sample(r'$\mu_{bottom}$', dist.Normal(1.02, 0.2))
        sigma_bottom = pyro.sample(r'$\sigma_{bottom}$', dist.Gamma(0.3, 3.0))
        y_bottom = pyro.sample(r'y_{bottom}', dist.Normal(mu_bottom, sigma_bottom), obs=torch.tensor([1.02]))

        mu_thickness = pyro.deterministic(r'$\mu_{thickness}$', mu_top - mu_bottom)
        sigma_thickness = pyro.sample(r'$\sigma_{thickness}$', dist.Gamma(0.3, 3.0))
        y_thickness = pyro.sample(r'y_{thickness}', dist.Normal(mu_thickness, sigma_thickness), obs=y_obs_list_)

    # Exploring model dependencies
    dependencies = get_dependencies(model, model_args=y_obs_list[:1])








.. GENERATED FROM PYTHON SOURCE LINES 89-93

Prior Sampling
--------------
Prior sampling is performed to understand the initial distribution of the model parameters
before considering the observed data.

.. GENERATED FROM PYTHON SOURCE LINES 93-97

.. code-block:: python3


    # Prior sampling
    prior = Predictive(model, num_samples=10)(y_obs_list)








.. GENERATED FROM PYTHON SOURCE LINES 98-102

Running MCMC Sampling
---------------------
Markov Chain Monte Carlo (MCMC) sampling is used to sample from the posterior distribution,
providing insights into the distribution of model parameters after considering the observed data.

.. GENERATED FROM PYTHON SOURCE LINES 102-108

.. code-block:: python3


    # Running MCMC using the NUTS algorithm
    nuts_kernel = NUTS(model)
    mcmc = MCMC(nuts_kernel, num_samples=100, warmup_steps=20)
    mcmc.run(y_obs_list)





.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    Warmup:   0%|          | 0/120 [00:00, ?it/s]    Warmup:   7%|6         | 8/120 [00:00, 77.84it/s, step size=2.73e-02, acc. prob=0.703]    Warmup:  13%|#3        | 16/120 [00:00, 22.78it/s, step size=1.16e-02, acc. prob=0.733]    Sample:  21%|##        | 25/120 [00:00, 34.89it/s, step size=1.53e-01, acc. prob=0.260]    Sample:  32%|###1      | 38/120 [00:00, 54.61it/s, step size=1.53e-01, acc. prob=0.223]    Sample:  41%|####      | 49/120 [00:00, 66.53it/s, step size=1.53e-01, acc. prob=0.297]    Sample:  49%|####9     | 59/120 [00:01, 71.07it/s, step size=1.53e-01, acc. prob=0.356]    Sample:  57%|#####6    | 68/120 [00:01, 71.04it/s, step size=1.53e-01, acc. prob=0.384]    Sample:  64%|######4   | 77/120 [00:01, 71.55it/s, step size=1.53e-01, acc. prob=0.414]    Sample:  72%|#######2  | 87/120 [00:01, 76.66it/s, step size=1.53e-01, acc. prob=0.443]    Sample:  80%|########  | 96/120 [00:01, 77.70it/s, step size=1.53e-01, acc. prob=0.474]    Sample:  89%|########9 | 107/120 [00:01, 85.59it/s, step size=1.53e-01, acc. prob=0.489]    Sample:  97%|#########6| 116/120 [00:01, 81.82it/s, step size=1.53e-01, acc. prob=0.513]    Sample: 100%|##########| 120/120 [00:01, 66.31it/s, step size=1.53e-01, acc. prob=0.529]





.. GENERATED FROM PYTHON SOURCE LINES 109-113

Posterior Predictive Sampling
-----------------------------
After obtaining the posterior samples, we perform posterior predictive sampling.
This step allows us to make predictions based on the posterior distribution.

.. GENERATED FROM PYTHON SOURCE LINES 113-118

.. code-block:: python3


    # Sampling from the posterior predictive distribution
    posterior_samples = mcmc.get_samples()
    posterior_predictive = Predictive(model, posterior_samples)(y_obs_list)








.. GENERATED FROM PYTHON SOURCE LINES 119-123

Visualizing the Results
-----------------------
We use ArviZ, a library for exploratory analysis of Bayesian models, to visualize
the results of our probabilistic model.

.. GENERATED FROM PYTHON SOURCE LINES 123-135

.. code-block:: python3


    # Creating a data object for ArviZ
    data = az.from_pyro(
        posterior=mcmc,
        prior=prior,
        posterior_predictive=posterior_predictive
    )

    # Plotting trace of the sampled parameters
    az.plot_trace(data)
    plt.show()




.. image-sg:: /examples_basic_geology/images/sphx_glr_1-thickness_problem_001.png
   :alt: $\mu_{bottom}$, $\mu_{bottom}$, $\mu_{top}$, $\mu_{top}$, $\sigma_{bottom}$, $\sigma_{bottom}$, $\sigma_{thickness}$, $\sigma_{thickness}$, $\sigma_{top}$, $\sigma_{top}$
   :srcset: /examples_basic_geology/images/sphx_glr_1-thickness_problem_001.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /home/leguark/.virtualenvs/gempy-geotop-pilot/lib/python3.10/site-packages/pkg_resources/__init__.py:123: PkgResourcesDeprecationWarning: gempy.-version- is an invalid version and will not be supported in a future release
      warnings.warn(
    /home/leguark/.virtualenvs/gempy-geotop-pilot/lib/python3.10/site-packages/arviz/data/io_pyro.py:157: UserWarning: Could not get vectorized trace, log_likelihood group will be omitted. Check your model vectorization or set log_likelihood=False
      warnings.warn(




.. GENERATED FROM PYTHON SOURCE LINES 136-140

Density Plots of Posterior and Prior
------------------------------------
Density plots provide a visual representation of the distribution of the sampled parameters.
Comparing the posterior and prior distributions allows us to assess the impact of the observed data.

.. GENERATED FROM PYTHON SOURCE LINES 140-150

.. code-block:: python3


    # Plotting density of posterior and prior distributions
    az.plot_density(
        data=[data, data.prior],
        shade=.9,
        data_labels=["Posterior", "Prior"],
        colors=[default_red, default_blue],
    )
    plt.show()




.. image-sg:: /examples_basic_geology/images/sphx_glr_1-thickness_problem_002.png
   :alt: $\mu_{bottom}$, $\mu_{top}$, $\sigma_{bottom}$, $\sigma_{thickness}$, $\sigma_{top}$
   :srcset: /examples_basic_geology/images/sphx_glr_1-thickness_problem_002.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 151-155

Density Plots of Posterior Predictive and Prior Predictive
----------------------------------------------------------
These plots show the distribution of the posterior predictive and prior predictive checks.
They help in evaluating the performance and validity of the probabilistic model.

.. GENERATED FROM PYTHON SOURCE LINES 155-166

.. code-block:: python3


    # Plotting density of posterior predictive and prior predictive
    az.plot_density(
        data=[data.posterior_predictive, data.prior_predictive],
        shade=.9,
        var_names=[r'$\mu_{thickness}$'],
        data_labels=["Posterior Predictive", "Prior Predictive"],
        colors=[default_red, default_blue],
    )
    plt.show()




.. image-sg:: /examples_basic_geology/images/sphx_glr_1-thickness_problem_003.png
   :alt: $\mu_{thickness}$
   :srcset: /examples_basic_geology/images/sphx_glr_1-thickness_problem_003.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 167-171

Marginal Distribution Plots
---------------------------
Marginal distribution plots provide insights into the distribution of individual parameters.
These plots help in understanding the uncertainty and variability in the parameter estimates.

.. GENERATED FROM PYTHON SOURCE LINES 171-184

.. code-block:: python3


    # Creating marginal distribution plots
    p = PlotPosterior(data)
    p.create_figure(figsize=(9, 5), joyplot=False, marginal=True, likelihood=False)
    p.plot_marginal(
        var_names=['$\\mu_{top}$', '$\\mu_{bottom}$'],
        plot_trace=False,
        credible_interval=.70,
        kind='kde',
        marginal_kwargs={"bw": 1}
    )
    plt.show()




.. image-sg:: /examples_basic_geology/images/sphx_glr_1-thickness_problem_004.png
   :alt: 1 thickness problem
   :srcset: /examples_basic_geology/images/sphx_glr_1-thickness_problem_004.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 185-189

Posterior Distribution Visualization
------------------------------------
This section provides a more detailed visualization of the posterior distributions
of the parameters, integrating different aspects of the probabilistic model.

.. GENERATED FROM PYTHON SOURCE LINES 189-207

.. code-block:: python3


    # Visualizing the posterior distributions
    p = PlotPosterior(data)
    p.create_figure(figsize=(9, 6), joyplot=True)
    iteration = 99
    p.plot_posterior(
        prior_var=['$\\mu_{top}$', '$\\mu_{bottom}$'],
        like_var=['$\\mu_{top}$', '$\\mu_{bottom}$'],
        obs='y_{thickness}',
        iteration=iteration,
        marginal_kwargs={
            "credible_interval": 0.94,
            'marginal_kwargs': {"bw": 1},
            'joint_kwargs': {"bw": 1}
        }
    )
    plt.show()




.. image-sg:: /examples_basic_geology/images/sphx_glr_1-thickness_problem_005.png
   :alt: Likelihood
   :srcset: /examples_basic_geology/images/sphx_glr_1-thickness_problem_005.png
   :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 .. code-block:: none

    /home/leguark/gempy_probability/gempy_probability/plot_posterior.py:239: UserWarning: color is redundantly defined by the 'color' keyword argument and the fmt string "bo" (-> color='b'). The keyword argument will take precedence.
      self.axjoin.plot(theta1_val, theta2_val, 'bo', ms=6, color='k')




.. GENERATED FROM PYTHON SOURCE LINES 208-212

Pair Plot of Key Parameters
---------------------------
Pair plots are useful to visualize the relationships and correlations between different parameters.
They help in understanding how parameters influence each other in the probabilistic model.

.. GENERATED FROM PYTHON SOURCE LINES 212-216

.. code-block:: python3


    # Creating a pair plot for selected parameters
    az.plot_pair(data, divergences=False, var_names=['$\\mu_{top}$', '$\\mu_{bottom}$'])
    plt.show()



.. image-sg:: /examples_basic_geology/images/sphx_glr_1-thickness_problem_006.png
   :alt: 1 thickness problem
   :srcset: /examples_basic_geology/images/sphx_glr_1-thickness_problem_006.png
   :class: sphx-glr-single-img






.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 0 minutes  5.299 seconds)


.. _sphx_glr_download_examples_basic_geology_1-thickness_problem.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example




    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: 1-thickness_problem.py <1-thickness_problem.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: 1-thickness_problem.ipynb <1-thickness_problem.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
